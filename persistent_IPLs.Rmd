---
title: "Persistent Lipids"
author: "Kaitlin Rempfert"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output:
  html_document: 
    df_print: paged 
    number_sections: yes 
    css: stylesheet.css 
    toc: yes 
    toc_float: true 
    toc_depth: 3 
    code_folding: show 
editor_options: 
  chunk_output_type: console
---

```{r setup, echo = FALSE, message=FALSE, warning=FALSE}
# load required packages
library(tidyverse)
library(ggplot2)
library(pmartR)
library(pander)
library(emmeans)
library(openxlsx)
library(ggpubr)
library(rstatix)
library(Rodin)
library(ComplexHeatmap)
library(CHNOSZ)
```

# Enrichment Data
## Import enrichment data
```{r}
isoR_enrich_long_pos <- readRDS("output/isoR_enrich_long_pos_4_23.RDS")
isoR_enrich_long_neg <- readRDS("output/isoR_enrich_long_neg_4_23.RDS")
```

## Reformat and combine positive mode and negative mode data
```{r}
#pos
#need to filter out reps that don't have compound detected in labeled and unlabeled as well as compounds that only show up in one paired rep
isoR_enrich_long_pos_filt <- isoR_enrich_long_pos %>% group_by(group, Identifier, Compound, Rep) %>% mutate(n = n()) %>% filter(n == 2) %>% ungroup() %>% group_by(group, Identifier, Compound) %>% mutate(n2 = n()) %>% filter(n2 > 2) %>% ungroup() %>% select(c(group, Compound, mean.enrichment, Label, Rep))
#calculate relative enrichment 
rel_enrich_pos <- isoR_enrich_long_pos_filt %>%
  group_by(group, Compound, Rep) %>% 
  pivot_wider(names_from = Label, values_from = mean.enrichment) %>% 
  summarise(labeled = dplyr::first(na.omit(labeled)),
      unlabeled = dplyr::first(na.omit(unlabeled))) %>%
  mutate(rel_enrichment = labeled - unlabeled, group_rep = paste0(group, "_", Rep))
##convert back to wide format 
SIP_lipid_pos <- rel_enrich_pos %>% tidyr::pivot_wider(id_cols = "Compound", names_from = "group_rep", values_from = "rel_enrichment")
##for now, filter to just switchgrass samples
SIP_lipid_pos <- SIP_lipid_pos %>% select(c("Compound", contains("S")))

#neg
#need to filter out reps that don't have compound detected in labeled and unlabeled as well as compounds that only show up in one paired rep
isoR_enrich_long_neg_filt <- isoR_enrich_long_neg %>% group_by(group, Identifier, Compound, Rep) %>% mutate(n = n()) %>% filter(n == 2) %>% ungroup() %>% group_by(group, Identifier, Compound) %>% mutate(n2 = n()) %>% filter(n2 > 2) %>% ungroup() %>% select(c(group, Compound, mean.enrichment, Label, Rep))
#calculate relative enrichment 
rel_enrich_neg <- isoR_enrich_long_neg_filt %>%
  group_by(group, Compound, Rep) %>% 
  pivot_wider(names_from = Label, values_from = mean.enrichment) %>% 
  summarise(labeled = dplyr::first(na.omit(labeled)),
      unlabeled = dplyr::first(na.omit(unlabeled))) %>%
  mutate(rel_enrichment = labeled - unlabeled, group_rep = paste0(group, "_", Rep))
##convert back to wide format 
SIP_lipid_neg <- rel_enrich_neg %>% tidyr::pivot_wider(id_cols = "Compound", names_from = "group_rep", values_from = "rel_enrichment")
##for now, filter to just switchgrass samples
SIP_lipid_neg <- SIP_lipid_neg %>% select(c("Compound", contains("S")))

#combine
SIP_lipid <- rbind(SIP_lipid_pos, SIP_lipid_neg)
```

## Create Inputs for pmartR
```{r}
#create lipid edata 
lipid_edata_enrich <- SIP_lipid

#create lipid fdata 
#read in metadata
lipid_fdata_enrich <- readxl::read_xlsx("incubation_metadata_w_qc.xlsx") %>% filter(group != "qc" & group != "blank" & group != "exclude") %>% filter(polarity == "negative") %>% filter(amendment == "NA_Gluc") %>% mutate(Rep= readr::parse_number(as.character(block)), group_rep = paste0(group,"_", Rep), site_crop_rep = paste0(site, "_", crop, "_", Rep)) %>% select(c(group_rep, group, site, crop, timepoint, site_crop_rep, catalog_number)) %>% distinct() %>% filter(crop == "Switchgrass")

#create lipid emeta
lipid_emeta_enrich <- SIP_lipid %>% select(Compound) %>% mutate(Class = case_when(
  grepl("Cer", Compound) ~ "Ceramides",
  grepl("DG", Compound) ~ "Diradylglycerols",
  grepl("DGTSA", Compound) ~ "Betaine lipids",
  grepl("PC", Compound) ~ "Glycerophosphocholines",
  grepl("PG", Compound) ~ "Glycerophosphoglycerols",
  grepl("PE", Compound) ~ "Glycerophosphoethanolamines",
  grepl("PI", Compound) ~ "Glycerophosphoinitosols",
  grepl("FA", Compound) ~ "Fatty acids",
  grepl("Hydroxy", Compound) ~ "Hydroxy Fatty acids",
  grepl("TG", Compound) ~ "Triadylglycerols",
  TRUE ~ "Other"
))

```

## Create lipidomic data object in pmartR
```{r}
#for pairing, need to filter out corn samples since they do not have 2 month timepoints
lipid_edata_enrich <- lipid_edata_enrich %>% select(c(starts_with("Compound"), contains("S")))
lipid_compounds_enrich <- lipid_edata_enrich$Compound
lipid_emeta_enrich <- lipid_emeta_enrich %>% filter(Compound %in% lipid_compounds_enrich)

#for now pretending like it is log10 scale so anova runs
mylipidData_enrich <- pmartR::as.lipidData(e_data = lipid_edata_enrich, f_data = lipid_fdata_enrich, e_meta = lipid_emeta_enrich, edata_cname = "Compound", emeta_cname = "Compound", fdata_cname = "group_rep", data_scale = "log10")
class(mylipidData_enrich)
```

### Boxplot
```{r}
bx <- lipid_edata_enrich %>% pivot_longer(cols = starts_with("M") | starts_with("W"), names_to = "sample", values_to = "relative atom% 13C enrichment")
ggboxplot(bx, x = "sample", y = "relative atom% 13C enrichment") + rotate_x_text()
```

## Switchgrass with timepoint; paired
```{r}
#remove EC5086
myfilter_enrich = custom_filter(mylipidData_enrich, f_data_remove = c("WS_2m_2", "WS_1y_2"))
mylipidData_enrich_filt = applyFilt(myfilter_enrich, mylipidData_enrich)

e_data_enrich_sg <- mylipidData_enrich_filt[["e_data"]]

e_data_enrich_sg_long <- e_data_enrich_sg %>% pivot_longer(cols = starts_with("M") | starts_with("W"), names_to = "sample", values_to = "relative atom% 13C enrichment")


#add in site info, timepoint info
e_data_enrich_long_meta <- e_data_enrich_sg_long %>% mutate(
  Site = case_when(
    grepl("M", sample) ~ "Michigan", 
    grepl("W", sample) ~ "Wisconsin"
   ), 
  Crop = case_when(
    grepl("S", sample) ~ "Switchgrass", 
    grepl("C", sample) ~ "Corn"
  ), 
  TimePoint = case_when(
    grepl("1y", sample) ~ "1year", 
    grepl("2m", sample) ~ "2month"
  ), 
  site_crop = case_when(
    grepl("MS", sample) ~ "Michigan SWG", 
    grepl("MC", sample) ~ "Michigan CRN",
    grepl("WS", sample) ~ "Wisconsin SWG", 
    grepl("WC", sample) ~ "Wisconsin CRN",
  )
) %>% ungroup() %>%
  dplyr::rename("atomperc" = "relative atom% 13C enrichment") %>%
  mutate(id = str_remove(sample, "_2m"), 
         id = str_remove(id, "_1y"), 
         TimePoint = factor(TimePoint, levels = c("2month", "1year")))

#saveRDS(e_data_enrich_long_meta, "output/e_data_enrich_long_meta.RDS")

#perform t-test (keep sites separate in case a lipid is persistent in one site and not another)
compound_enrichment_ttest_sep <- e_data_enrich_long_meta  %>%
  select(c(Compound, Site, TimePoint, id, atomperc)) %>%
  arrange(Compound, Site, TimePoint, id) %>%
  group_by(Compound, Site) %>%
  t_test(atomperc ~ TimePoint, paired = TRUE) %>%
  add_significance(cutpoints = c(0, 1e-04, 0.001, 0.01, 0.1, 1),
  symbols = c("****", "***", "**", "*", "ns"))
#perform t-test again without separating sites
compound_enrichment_ttest <- e_data_enrich_long_meta  %>%
  select(c(Compound, Site, TimePoint, id, atomperc)) %>%
  arrange(Compound, Site, TimePoint, id) %>%
  group_by(Compound) %>%
  t_test(atomperc ~ TimePoint, paired = TRUE) %>%
  add_significance(cutpoints = c(0, 1e-04, 0.001, 0.01, 0.1, 1),
  symbols = c("****", "***", "**", "*", "ns"))
    
#calculate Cohen's d (keep sites separate in case a lipid is persistent in one site and not another)
compound_enrichment_cohens_sep <- e_data_enrich_long_meta %>% 
  select(c(Compound, Site, TimePoint, id, atomperc)) %>%
  arrange(Compound, Site, TimePoint, id) %>%
  group_by(Compound, Site) %>%
  cohens_d(atomperc ~ TimePoint, paired = TRUE)  
#perform Cohen's d without separating sites 
compound_enrichment_cohens <- e_data_enrich_long_meta %>% 
  select(c(Compound, Site, TimePoint, id, atomperc)) %>%
  arrange(Compound, Site, TimePoint, id) %>%
  group_by(Compound) %>%
  cohens_d(atomperc ~ TimePoint, paired = TRUE)  

#combine t-test and cohen's d outputs
compound_enrichment_stats_sep <- left_join(compound_enrichment_ttest_sep, compound_enrichment_cohens_sep)
compound_enrichment_stats <- left_join(compound_enrichment_ttest, compound_enrichment_cohens)

#reformat output for joining for intensity data 
compound_enrichment_stats_rf_sep <- left_join(e_data_enrich_long_meta, compound_enrichment_stats_sep %>% select(c(Compound, Site, group1, group2, p, effsize)) %>% dplyr::rename("p_enrich" = "p") %>% dplyr::rename("effsize_enrich" = "effsize"))
compound_enrichment_stats_rf <- left_join(e_data_enrich_long_meta, compound_enrichment_stats %>% select(c(Compound, group1, group2, p, effsize)) %>% dplyr::rename("p_enrich" = "p") %>% dplyr::rename("effsize_enrich" = "effsize"))
```


# Intensity Data
## Import Intensity Data
```{r}
#read in abundance data from pmartR
mylipidData <- readRDS("output/pmartR/mylipidData.rds")
```

```{r}
lipid_e <- mylipidData[["e_data"]]

#reformat e-data
lipidomics_samples <- lipid_e  %>% mutate(Compound = str_remove_all(Compound, "mylipidData_neg_")) %>% column_to_rownames("Compound") %>% t() %>% as.data.frame() %>% rownames_to_column("catalog_name") %>% rowwise() %>%
dplyr::mutate(catalog_number = strsplit(catalog_name, split="_")[[1]][1]) %>% filter(!grepl("QC", catalog_name)) %>% select(-catalog_name) %>% column_to_rownames("catalog_number") %>% t() %>% as.data.frame() %>% rownames_to_column("Compound")

e_data_sg_long <- lipidomics_samples %>% pivot_longer(cols = starts_with("EC"), names_to = "catalog_number", values_to = "log2_intensity") 

#join with enrichment data to get correct labeling scheme 
e_data_sg_long_meta <- left_join(lipid_fdata_enrich, e_data_sg_long) %>% filter(group_rep != "WS_2m_2") %>% filter(group_rep != "WS_1y_2") 

#add in site_crop column and switch labeling for timepoints 
e_data_long_meta <- e_data_sg_long_meta %>% mutate(
  sample = group_rep,
  Site = case_when(
    grepl("M", sample) ~ "Michigan", 
    grepl("W", sample) ~ "Wisconsin"
   ), 
  Crop = case_when(
    grepl("S", sample) ~ "Switchgrass", 
    grepl("C", sample) ~ "Corn"
  ), 
  TimePoint = case_when(
    grepl("1y", sample) ~ "1year", 
    grepl("2m", sample) ~ "2month"
  ), 
  site_crop = case_when(
    grepl("MS", sample) ~ "Michigan SWG", 
    grepl("MC", sample) ~ "Michigan CRN",
    grepl("WS", sample) ~ "Wisconsin SWG", 
    grepl("WC", sample) ~ "Wisconsin CRN",
  )
) %>% unique()

#filter to compounds that were detected at both 2 months and 1 year 
e_data_long_meta_filt <- e_data_long_meta %>% filter(!is.na(log2_intensity)) %>% group_by(site_crop_rep, Compound) %>% mutate(n = sum(!is.na(log2_intensity))) %>% filter(n == 2) %>% ungroup() %>% group_by(group, Compound) %>% mutate(reps = sum(!is.na(log2_intensity))) %>% ungroup() %>%
  mutate(id = str_remove(sample, "_2m"), 
         id = str_remove(id, "_1y"), 
         TimePoint = factor(TimePoint, levels = c("2month", "1year"))) 

#saveRDS(e_data_long_meta_filt, "output/e_data_long_meta_filt.RDS")

#perform t-test (keep sites separate in case a lipid is persistent in one site and not another)
compound_intensity_ttest_sep <- e_data_long_meta_filt  %>%
  filter(reps > 3) %>%
  select(c(Compound, Site, TimePoint, id, log2_intensity)) %>%
  arrange(Compound, Site, TimePoint, id) %>%
  group_by(Compound, Site) %>%
  t_test(log2_intensity ~ TimePoint, paired = TRUE, var.equal = FALSE) %>%
  add_significance(cutpoints = c(0, 1e-04, 0.001, 0.01, 0.1, 1),
  symbols = c("****", "***", "**", "*", "ns"))
#perform t-test again without separating sites 
compound_intensity_ttest <- e_data_long_meta_filt  %>%
  filter(reps > 3) %>%
  select(c(Compound, Site, TimePoint, id, log2_intensity)) %>%
  arrange(Compound, Site, TimePoint, id) %>%
  group_by(Compound) %>%
  t_test(log2_intensity ~ TimePoint, paired = TRUE, var.equal = FALSE) %>%
  add_significance(cutpoints = c(0, 1e-04, 0.001, 0.01, 0.1, 1),
  symbols = c("****", "***", "**", "*", "ns"))
    
#calculate Cohen's d (keep sites separate in case a lipid is persistent in one site and not another)
compound_intensity_cohens_sep <-e_data_long_meta_filt %>% 
  filter(reps > 3) %>%
  select(c(Compound, Site, TimePoint, id, log2_intensity)) %>%
  arrange(Compound, Site, TimePoint, id) %>%
  group_by(Compound, Site) %>%
 cohens_d(log2_intensity ~ TimePoint, paired = TRUE) %>%
  add_significance(cutpoints = c(0, 1e-04, 0.001, 0.01, 0.1, 1),
  symbols = c("****", "***", "**", "*", "ns"))
#recalculate without separating sites
compound_intensity_cohens <-e_data_long_meta_filt %>% 
  filter(reps > 3) %>%
  select(c(Compound, Site, TimePoint, id, log2_intensity)) %>%
  arrange(Compound, Site, TimePoint, id) %>%
  group_by(Compound) %>%
 cohens_d(log2_intensity ~ TimePoint, paired = TRUE) %>%
  add_significance(cutpoints = c(0, 1e-04, 0.001, 0.01, 0.1, 1),
  symbols = c("****", "***", "**", "*", "ns"))

#combine t-test and cohen's d outputs
compound_intensity_stats_sep <- left_join(compound_intensity_ttest_sep, compound_intensity_cohens_sep)
compound_intensity_stats <- left_join(compound_intensity_ttest, compound_intensity_cohens)

#reformat output for joining for intensity data 
compound_intensity_stats_rf_sep <- left_join(e_data_long_meta_filt, compound_intensity_stats_sep %>% select(c(Compound, Site, group1, group2, p, effsize)) %>% dplyr::rename("p_intensity" = "p") %>% dplyr::rename("effsize_intensity" = "effsize"))
compound_intensity_stats_rf <- left_join(e_data_long_meta_filt, compound_intensity_stats %>% select(c(Compound, group1, group2, p, effsize)) %>% dplyr::rename("p_intensity" = "p") %>% dplyr::rename("effsize_intensity" = "effsize"))
```

Quantification of the effect size magnitude is performed using the thresholds defined in Cohen (1992). The magnitude is assessed using the thresholds provided in (Cohen 1992), i.e. |d| < 0.2 "negligible", |d| < 0.5 "small", |d| < 0.8 "medium", otherwise "large".

## Combine 
```{r}
compound_stats_combined_sep <- left_join(compound_enrichment_stats_rf_sep, compound_intensity_stats_rf_sep)
compound_stats_combined <- left_join(compound_enrichment_stats_rf, compound_intensity_stats_rf)

#add categorical groupings 
compounds_classified <- compound_stats_combined %>% mutate(
  classification = case_when(
    #persistent: p_enrich > 0.05, abs(effsize_enrich) < 0.2, p_intensity > 0.05, abs(effsize_intensity) < 0.2
    p_enrich > 0.01 & abs(effsize_enrich) < 0.2 & p_intensity > 0.01 & abs(effsize_intensity) < 0.2 ~ "persistent",
    #continued production (labeled): p_intensity < 0.05, effsize_intensity > 0.5, p_enrich < 0.05, effsize_enrich > 0.5; effsize_intensity > 0.5, p_enrich < 0.05, effsize_enrich < -0.5 (unlabeled)
    p_intensity < 0.01 & effsize_intensity > 0.8  ~ "continued production", 
    #degradation:  p_intensity < 0.05, effsize_intensity < -0.5, (old lipid) p_enrich < 0.05, effsize_enrich > 0.5, (new lipid) p_enrich < 0.05, effsize_enrich < -0.5
    p_intensity < 0.01 & effsize_intensity < -0.8  ~ "degraded", 
    TRUE ~ "unclassified"
  )
)
#separated 
compounds_classified_sep <- compound_stats_combined_sep %>% mutate(
    classification = case_when(
    #persistent: p_enrich > 0.05, abs(effsize_enrich) < 0.2, p_intensity > 0.05, abs(effsize_intensity) < 0.2
    p_enrich > 0.01 & abs(effsize_enrich) < 0.2 & p_intensity > 0.01 & abs(effsize_intensity) < 0.2 ~ "persistent",
    #continued production (labeled): p_intensity < 0.05, effsize_intensity > 0.5, p_enrich < 0.05, effsize_enrich > 0.5; effsize_intensity > 0.5, p_enrich < 0.05, effsize_enrich < -0.5 (unlabeled)
    p_intensity < 0.01 & effsize_intensity > 0.8  ~ "continued production", 
    #degradation:  p_intensity < 0.05, effsize_intensity < -0.5, (old lipid) p_enrich < 0.05, effsize_enrich > 0.5, (new lipid) p_enrich < 0.05, effsize_enrich < -0.5
    p_intensity < 0.01 & effsize_intensity < -0.8  ~ "degraded", 
    TRUE ~ "unclassified"
  )
)

#add site designations 
#create df of site designations by compound v classification 
#site_desig <- compounds_classified_sep %>% select(c(Compound, Site, classification)) %>% distinct() %>% group_by(Compound, classification) %>% mutate(n = n(), site_desig = ifelse(n == 2, "Both", Site)) %>% select(-c(Site, n)) %>% distinct()
#if both, use unseparated stats
#create vector of compounds where there is no site difference in classification 
#both <- site_desig %>% ungroup() %>% filter(site_desig == "Both") %>% select(Compound) 
#both <- both$Compound
#select rows from unseparated data with compounds in this vector
#compounds_classified_filt <- compounds_classified %>% filter(Compound %in% both) %>% mutate(site_desig = "Both")
#select rows from separated data with compounds not in this vector
#`%nin%` <- negate(`%in%`)
#compounds_classified_sep_filt <- compounds_classified_sep %>% filter(Compound %nin% both) %>% mutate(site_desig = Site)
#merge 
#compounds_classified_sep <- rbind(compounds_classified_filt, compounds_classified_sep_filt)
#for data separated by site
#create df of site designations by compound v classification 
#compounds_classified_sep <- compounds_classified_sep %>% select(c(Compound, Site, classification)) %>% distinct() %>% group_by(Compound, classification) %>% mutate(n = n(), site_desig = ifelse(n == 2, "Both", Site)) %>% select(-c(Site, n)) %>% distinct()
```

# Enrichment differences with site
```{r}
#perform t-test 
compound_enrichment_ttest_site <- e_data_enrich_long_meta %>% 
  filter(sample != "MS_1y_2") %>%
  filter(sample != "MS_2m_2") %>%
  select(c(Compound, TimePoint, Site, id, atomperc)) %>%
  arrange(Compound, TimePoint, Site, id) %>%
  group_by(Compound) %>%
  t_test(atomperc ~ Site, paired = FALSE, var.equal = FALSE) %>%
  add_significance(cutpoints = c(0, 1e-04, 0.001, 0.01, 0.1, 1),
  symbols = c("****", "***", "**", "*", "ns"))
    
#calculate Cohen's d 
compound_enrichment_cohens_site <- e_data_enrich_long_meta %>% 
  filter(sample != "MS_1y_2") %>%
  filter(sample != "MS_2m_2") %>%
  select(c(Compound, TimePoint, Site, id, atomperc)) %>%
  arrange(Compound, TimePoint, Site, id) %>%
  group_by(Compound) %>%
  cohens_d(atomperc ~ Site, paired = FALSE) %>%
  add_significance(cutpoints = c(0, 1e-04, 0.001, 0.01, 0.1, 1),
  symbols = c("****", "***", "**", "*", "ns"))

#combine t-test and cohen's d outputs
compound_enrichment_stats_site <- left_join(compound_enrichment_ttest_site, compound_enrichment_cohens_site)

#reformat output for joining for intensity data 
compound_enrichment_stats_rf_site <- compound_enrichment_stats_site %>% select(c(Compound, group1, group2, p, effsize)) %>% dplyr::rename("p_enrich" = "p") %>% dplyr::rename("effsize_enrich" = "effsize")
```

# Intensity differences with Site 
```{r}
#filter to compounds that were detected in four reps 
e_data_long_meta_filt <- e_data_long_meta %>% filter(!is.na(log2_intensity)) %>% filter(sample != "MS_1y_2") %>% group_by(Compound, Site) %>% mutate(n = sum(!is.na(log2_intensity))) %>% ungroup() %>% filter(n > 6) %>% ungroup() %>%
  mutate(id = str_remove(sample, "_2m"), 
         id = str_remove(id, "_1y"), 
         TimePoint = factor(TimePoint, levels = c("2month", "1year")),
         Site = factor(Site, levels = c("Wisconsin", "Michigan")))

#perform t-test
compound_intensity_ttest_site <- e_data_long_meta_filt  %>%
  select(c(Compound, Site, TimePoint, id, log2_intensity)) %>%
  arrange(Compound, TimePoint, Site, id) %>%
  group_by(Compound) %>%
  t_test(log2_intensity ~ Site, var.equal = FALSE) %>%
  add_significance(cutpoints = c(0, 1e-04, 0.001, 0.01, 0.1, 1),
  symbols = c("****", "***", "**", "*", "ns"))
    
#calculate Cohen's d 
compound_intensity_cohens_site <- e_data_long_meta_filt %>%
  select(c(Compound, Site, TimePoint, id, log2_intensity)) %>%
  arrange(Compound, Site, TimePoint, id) %>%
  group_by(Compound) %>%
 cohens_d(log2_intensity ~ Site, paired = FALSE) %>%
  add_significance(cutpoints = c(0, 1e-04, 0.001, 0.01, 0.1, 1),
  symbols = c("****", "***", "**", "*", "ns"))

#combine t-test and cohen's d outputs
compound_intensity_stats_site <- left_join(compound_intensity_ttest_site, compound_intensity_cohens_site)

#reformat output for joining for intensity data 
compound_intensity_stats_rf_site <- compound_intensity_stats_site %>% select(c(Compound, group1, group2, p, effsize)) %>% dplyr::rename("p_intensity" = "p") %>% dplyr::rename("effsize_intensity" = "effsize")
```


## Combine 
```{r}
compound_stats_combined_site <- left_join(compound_enrichment_stats_rf_site, compound_intensity_stats_rf_site)

#add categorical groupings 
compounds_classified_site <- compound_stats_combined_site %>% mutate(
  site_classification = case_when(
    #both enrichment and intensity -> need to break down into sites further 
    p_enrich < 0.05 & effsize_enrich > 0.2 & p_intensity < 0.05 & effsize_intensity > 0.2 ~ "Wisconsin enrichment and intensity",
    p_enrich < 0.05 & effsize_enrich < -0.2 & p_intensity < 0.05 & effsize_intensity < -0.2 ~ "Michigan enrichment and intensity",
    p_enrich < 0.05 & effsize_enrich > 0.2 & p_intensity < 0.05 & effsize_intensity < -0.2 ~ "Wisconsin enrichment and Michigan intensity",
    p_enrich < 0.05 & effsize_enrich < -0.2 & p_intensity < 0.05 & effsize_intensity > 0.2 ~ "Michigan enrichment and Wisconsin intensity",
    #enrichment 
    p_enrich < 0.05 & effsize_enrich > 0.2  ~ "enrichment Wisconsin",
    p_enrich < 0.05 & effsize_enrich < -0.2  ~ "enrichment Michigan",
    #intensity 
    p_intensity < 0.05 & effsize_intensity > 0.2  ~ "intensity Wisconsin",
    p_intensity < 0.05 & effsize_intensity < 0.2  ~ "intensity Michigan",
      TRUE ~ "unclassified"
  )
  )

#add site classification to timepoint dataframe
#unseparated
all_classified <- left_join(compounds_classified, compounds_classified_site %>% select(c(Compound, site_classification)))
#separated
all_classified_sep <- left_join(compounds_classified_sep, compounds_classified_site %>% select(c(Compound, site_classification)))

#summarized
#not separated by site
all_classified_summarized <- all_classified %>% 
   group_by(Compound) %>%
  mutate(
    atomperc_avg = mean(atomperc, na.rm = TRUE), 
    log2_intensity_avg = mean(log2_intensity, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  #need to pivot data to calculate ratio of intensities between timepoints 
  group_by(Compound, TimePoint) %>%
  mutate(
    intensity_timepoint_avg = mean(log2_intensity, na.rm = TRUE),
    atomperc_timepoint_avg = mean(atomperc, na.rm = TRUE)
  ) %>%
  ungroup() %>%
    pivot_wider(names_from = TimePoint, values_from = c(intensity_timepoint_avg, atomperc_timepoint_avg)) %>%
  fill(intensity_timepoint_avg_1year, .direction = "down") %>%
  fill(atomperc_timepoint_avg_1year, .direction = "down") %>%
  fill(intensity_timepoint_avg_2month, .direction = "up") %>%
  fill(atomperc_timepoint_avg_2month, .direction = "up") %>%
  mutate(log2FC_intensity = intensity_timepoint_avg_2month - intensity_timepoint_avg_1year) %>%
  select(c(Compound, atomperc_avg, log2_intensity_avg, log2FC_intensity, atomperc_timepoint_avg_1year, p_enrich, effsize_enrich, p_intensity, effsize_intensity, classification, site_classification)) %>% distinct()

#separated by site
all_classified_sep_summarized <- all_classified_sep %>% 
   group_by(Compound, Site) %>%
  mutate(
    atomperc_avg = mean(atomperc, na.rm = TRUE), 
    log2_intensity_avg = mean(log2_intensity, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  #need to pivot data to calculate ratio of intensities between timepoints 
  group_by(Compound, Site, TimePoint) %>%
  mutate(
    intensity_timepoint_avg = mean(log2_intensity, na.rm = TRUE),
    atomperc_timepoint_avg = mean(atomperc, na.rm = TRUE)
  ) %>%
  ungroup() %>%
    pivot_wider(names_from = TimePoint, values_from = c(intensity_timepoint_avg, atomperc_timepoint_avg)) %>%
  fill(intensity_timepoint_avg_1year, .direction = "down") %>%
  fill(atomperc_timepoint_avg_1year, .direction = "down") %>%
  fill(intensity_timepoint_avg_2month, .direction = "up") %>%
  fill(atomperc_timepoint_avg_2month, .direction = "up") %>%
  mutate(log2FC_intensity = intensity_timepoint_avg_2month - intensity_timepoint_avg_1year) %>%
  select(c(Compound, Site, atomperc_avg, log2_intensity_avg, log2FC_intensity, atomperc_timepoint_avg_1year, p_enrich, effsize_enrich, p_intensity, effsize_intensity, classification, site_classification)) %>% distinct()
```

# Create Heatmap Tables 
## NOSC calculations 
```{r}
lipid_meta <- mylipidData[["e_meta"]]
lipid_meta <- lipid_meta %>% mutate(Compound = str_remove_all(Compound, "mylipidData_neg_"))

formulas <- lipid_meta$Formula
formulas_sep <- makeup(formulas, count.zero = TRUE)
formulas_df <- data.table(Formula.1 = formulas)[
  ,names(formulas_sep[[1]]) := transpose(formulas_sep)
]
formulas_df <- formulas_df %>% mutate(
  C = as.numeric(C),
  H = as.numeric(H), 
  N = as.numeric(N), 
  O = as.numeric(O), 
  P = as.numeric(P)
  )

lipid_meta_formulas <- cbind(lipid_meta, formulas_df) %>% select(-Formula.1)

lipid_meta_formulas <- lipid_meta_formulas %>% mutate(NOSC = 4 - ((4*C + H - 3*N - 2*O + 5*P)/C))
```

## Use Rodin to pull out double bond and chain info
```{r}
#Use package Rodin to get #C and #db from chemical formulas 
Query <-  all_classified_summarized %>% select(Compound) %>% distinct()
cleaned.queryExample <- clean.lipid.list(Query)
mined <- lipid.miner(cleaned.queryExample, name="Query", TGcollapse.rm = FALSE)
#calculate per chain length C and DBE
Query.intact.calc <- Query.intact %>% mutate(
  `Number of Chains` = case_when(
    `Main class` == "TG" ~ 3, 
    TRUE ~ 2
  ), 
  `Mean # of C per chain` = `Total Number of Carbon`/`Number of Chains`,
  `Mean DBE per chain` = `Double Bonds`/`Number of Chains`
)
#edit classes and add hydroxlation, backbone linkage, and category columns
lipidomics_meta <- Query.intact.calc %>% select(c(Lipid, `Main class`, `Sub class`, `Total Number of Carbon`, `Double Bonds`, `Mean # of C per chain`, `Mean DBE per chain`)) %>% mutate(
  `Main class` = case_when(
    grepl("DGTSA", Lipid) ~ "DGTSA", 
    grepl("HydroxyphthioceranicAcid", Lipid) ~ "FA",
    grepl("FA", Lipid) ~ "FA", 
    TRUE ~ `Main class`
  ), 
  `Sub class` = case_when(
    grepl("hydroxy", `Sub class`) ~ "hydroxy",
    grepl("O-", `Sub class`) ~ "plasmanyl", 
    grepl("P-", `Sub class`) ~ "plasmologen",
    TRUE ~ ""
  ),
  Lipid = case_when(
    grepl("HydroxyphthioceranicAcid(31:0)", Lipid, fixed = TRUE) ~ "FA(31:0(OH))",
    grepl("HydroxyphthioceranicAcid(39:0)", Lipid, fixed = TRUE) ~ "FA(39:0(OH))",
    grepl("HydroxyphthioceranicAcid(40:0)", Lipid, fixed = TRUE) ~ "FA(40:0(OH))",
    TRUE ~ Lipid
  ),
  DBE = case_when(
    `Double Bonds` == 0 ~ "0", 
    `Double Bonds` == 1 | `Double Bonds` == 2 ~ "1-2",
    `Double Bonds` < 7 & `Double Bonds` > 2 ~ "3-6",
    `Double Bonds` > 6  ~ "7+"
  ),
  Hydroxylations = case_when(
    grepl("2OH", Lipid) ~ "2",
    grepl("Cer", Lipid) | grepl("Hydroxy", `Lipid`) ~ "1",
    TRUE ~ "0"
  ),
  `Backbone linkage` = case_when(
    grepl("plasm", `Sub class`) ~ "alkyl",
    grepl("Cer", Lipid) ~ "amide", 
    TRUE ~ "acyl"
  ),
  Category = case_when(
    `Main class` == "DG" | `Main class` == "TG" | `Main class` == "DGTSA" ~ "Glycerolipid", 
    `Main class` == "FA" ~ "Fatty acyls", 
    `Main class` == "Cer" ~ "Sphingolipid", 
    TRUE ~ "Glycerophospholipid")
) %>% dplyr::rename("Compound" = "Lipid")

lipidomics_meta_f <- left_join(lipidomics_meta, lipid_meta_formulas %>% select(-Category))
#saveRDS(lipidomics_meta_f,file="output/lipidomics_Rodin_meta.RDS")

all_summarized_w_Rodin <- left_join(all_classified_summarized, lipidomics_meta_f)
all_summarized_sep_w_Rodin <- left_join(all_classified_sep_summarized, lipidomics_meta_f)
all_w_Rodin <- left_join(all_classified, lipidomics_meta_f)
#saveRDS(all_w_Rodin,file="output/all_w_Rodin.Rds")
#saveRDS(all_summarized_w_Rodin, file="output/all_summarized_w_Rodin.Rds")
```

# ComplexHeatmap Tables
## Prepare dataframe for Complexheatmap
```{r}
#reorder data (MI switchgrass 2 month, MI switchgrass 1 year...then WI with same pattern)
lipids_wmeta_ordered <- all_summarized_w_Rodin %>% select(c(Compound, `Main class`, `Sub class`, `Total Number of Carbon`, `Double Bonds`, `Mean # of C per chain`, `Mean DBE per chain`, DBE, Hydroxylations, NOSC, `Backbone linkage`, Category, classification, atomperc_avg, atomperc_timepoint_avg_1year, p_enrich, effsize_enrich, log2_intensity_avg, p_intensity, effsize_intensity, log2FC_intensity, site_classification)) %>% 
#remove any rows with NA values 
  na.omit() %>%
  mutate(classification = factor(classification, levels = c("persistent", "continued production", "degraded",  "unclassified"))) %>%
  group_by(classification, `Main class`) %>% arrange(classification, effsize_enrich) 
#%>% mutate(atomperc_avg = atomperc_avg * 100, atomperc_avg_1year = atomperc_timepoint_avg_1year * 100)
#sep
#reorder data (MI switchgrass 2 month, MI switchgrass 1 year...then WI with same pattern)
lipids_wmeta_ordered_sep <- all_summarized_sep_w_Rodin %>% select(c(Compound, `Main class`, `Sub class`, `Total Number of Carbon`, `Double Bonds`, `Mean # of C per chain`, `Mean DBE per chain`, DBE, Hydroxylations, NOSC, `Backbone linkage`, Category, classification, Site, atomperc_avg, atomperc_timepoint_avg_1year, p_enrich, effsize_enrich, log2_intensity_avg, p_intensity, effsize_intensity, log2FC_intensity, site_classification)) %>% 
  dplyr::rename("site_desig" = "Site") %>%
#remove any rows with NA values 
  na.omit() %>%
  mutate(classification = factor(classification, levels = c("persistent", "continued production", "degraded",  "unclassified"))) %>%
  group_by(classification, `Main class`, site_desig) %>% arrange(classification, effsize_enrich) 

#remove "unclassified"
just_classified <- lipids_wmeta_ordered %>% filter(classification != "unclassified") 
just_classified_sep <- lipids_wmeta_ordered_sep %>% filter(classification != "unclassified") 

#row grouping vector
classification = just_classified$classification
classification_sep = just_classified_sep$classification
```


## Tables
### Set colors
```{r}
#color scales
sunset <- khroma::color("sunset")
sunset(18)
muted <- khroma::color("muted")
muted(9)
paired <- RColorBrewer::brewer.pal(10, "Paired")
vibrant <- khroma::color("vibrant")
vibrant(6)


col_sunset_custom <- c("#FFFFFF", "#EFE6B8", "#FBDC92", "#FDC779", "#FCAF64", "#F89054", "#F06E43", "#E14832", "#C5232A", "#A50026")

col_muted <- c("#CC6677", "#332288", "#DDCC77", "#117733", "#88CCEE", "#882255", "#44AA99", "#999933", "#AA4499", "#DDDDDD")

col_paired <- c("#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C", "#FB9A99", "#E31A1C", "#FDBF6F", "#FF7F00", "#CAB2D6", "#6A3D9A")

col_lipid <- col_paired <- c("#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C", "#FB9A99", "#E31A1C", "#FDBF6F", "#FF7F00", "#CAB2D6")

col_classifications <- c("#33BBEE", "#009988","#EE7733")

col_atm_fun = circlize::colorRamp2(c(0, 0.05), c("white", "#FF7F00"))
#col_atm <- col_atm_fun(seq(-0.5, 5))

col_C_fun = circlize::colorRamp2(c(15, 20), c("white", "#E31A1C"))

col_DBE_fun = circlize::colorRamp2(c(0, 4), c("white", "#1F78B4"))

col_NOSC_fun = circlize::colorRamp2(c(-1.8, -1.3), c("white", "#6A3D9A"))
```

### All classifications, no site specific stats
```{r}
#atom percent
#matrix
mat_atmperc <- as.matrix(just_classified$atomperc_timepoint_avg_1year)

h_atmperc2 <- Heatmap(mat_atmperc, name = "EAF", row_split = just_classified$classification, col = col_atm_fun, row_title = NULL, column_title = expression(""^13*"C EAF"[year]), cluster_rows = FALSE, cluster_row_slices = FALSE, column_title_side = "bottom", width = unit(3, "cm"))

#p value enrichment
p_enrich = as.vector(just_classified$p_enrich)
# label significant with asterisk
is_sig = p_enrich < 0.01
pch = rep("*", length(is_sig))
pch[!is_sig] = NA
# color mapping for -log10(pvalue)
pvalue_col_fun = circlize::colorRamp2(c(0, 2, 3), c("#33A02C", "white", "#6A3D9A")) 
ha2 = rowAnnotation(p = anno_simple(-log10(p_enrich), 
        col = pvalue_col_fun, pch = pch), annotation_name_rot = 0)
# generate two legends
# legend for pvalue
lgd_pvalue = Legend(title = "p-value", col_fun = pvalue_col_fun, at = c(0, 1, 2, 3), 
    labels = c("1", "0.1", "0.01", "0.001"))
# and one for the significant p-values
lgd_sig = Legend(pch = "*", type = "points", labels = "< 0.01")


#D value enrichment
effsize_enrich = as.vector(just_classified$effsize_enrich)
effsize_enrich <- round(effsize_enrich, digits = 1)
ha1 = rowAnnotation("d" = anno_numeric(effsize_enrich, 
        bg_gp = gpar(fill = ifelse(effsize_enrich > 0, "#33A02C", "#6A3D9A"), col = ifelse(effsize_enrich > 0, "#33A02C", "#6A3D9A"))), annotation_name_rot = 0)

#intensity barplot
ratio = as.vector(just_classified$log2FC_intensity)
ha3 = rowAnnotation("Log2FC intensity" = anno_barplot(ratio, baseline = 0, gp = gpar(fill = "#1F78B4", col = "#1F78B4"), width = unit(3, "cm")))

#p value intensity
#p value enrichment
p_intensity = as.vector(just_classified$p_intensity)
# label significant with asterisk
is_sig2 = p_intensity < 0.01
pch2 = rep("*", length(is_sig2))
pch2[!is_sig2] = NA

ha5 = rowAnnotation(p = anno_simple(-log10(p_intensity), 
        col = pvalue_col_fun, pch = pch2), annotation_name_rot = 0)

#D value intensity 
effsize_intensity = as.vector(just_classified$effsize_intensity)
effsize_intensity <- round(effsize_intensity, digits = 1)
ha4 = rowAnnotation("d" = anno_numeric(effsize_intensity, 
        bg_gp = gpar(fill = ifelse(effsize_intensity > 0, "#33A02C", "#6A3D9A"), col = ifelse(effsize_intensity > 0, "#33A02C", "#6A3D9A"))), annotation_name_rot = 0)


#Lipid type annotations 
#vector for colors 
class_colors <- just_classified %>% mutate(class_colors = case_when(
  `Main class` == "DG" ~ "#FDBF6F",
  `Main class` == "FA" ~ "#CAB2D6", 
  `Main class` == "PC" ~ "#A6CEE3", 
  `Main class` == "PE" ~ "#1F78B4", 
  `Main class` == "PG" ~ "#B2DF8A", 
  `Main class` == "PI" ~ "#33A02C", 
  `Main class` == "TG" ~ "#FF7F00", 
  `Main class` == "Cer" ~"#FB9A99", 
  `Main class` == "DGTSA" ~ "#E31A1C",
),
class_colors = as.character(class_colors)) %>% ungroup() %>% select(c(class_colors, `Main class`)) 
class_colors_vec = class_colors$class_colors

class_colors_uniq = class_colors %>% distinct() %>% mutate(`Main class` = factor(`Main class`, levels = c("PC", "PE", "PG", "PI", "Cer", "DGTSA", "DG", "TG", "FA"))) %>% arrange(`Main class`)

ha_lipid = rowAnnotation(
  #class annotation 
    Class = anno_text(just_classified$`Compound`, location = 0.5, just = "center", gp = gpar(fill = class_colors_vec, col = "white")))
lgd_lipid = Legend(title = "Lipid class", legend_gp = gpar(fill = class_colors_uniq$class_colors),
    labels = class_colors_uniq$`Main class`)

 #list(bar = c("a" = "red", "b" = "green", "c" = "blue"))
  
#Lipid formula annotations 
ha_formula = rowAnnotation(
   #DBE
    `chain DBE` = just_classified$`Mean DBE per chain`,
  #total C annotation 
    `chain C` = just_classified$`Mean # of C per chain`,
  #NOSC
  NOSC = just_classified$NOSC,
    col = list(`chain DBE` = col_DBE_fun, `chain C` = col_C_fun, NOSC = col_NOSC_fun)
)

#group by classification 
ha_class <- rowAnnotation(Classification = classification, show_annotation_name = FALSE, show_legend = FALSE,
    col = list(Classification = c("persistent" = "#CAB2D6", "continued production" = "#B2DF8A", "degraded" = "#A6CEE3")))
#label classifications
text_list = list(
    text1 = "persistent",
    text2 = "continued production",
    text3 = "degraded"
)
ha_empty = rowAnnotation(foo = anno_empty(border = FALSE, 
    width = unit(5, "mm")))
        #,annotation_legend_param = list(
            #classification = list(direction = "horizontal", title_position = "lefttop", nrow = 1)))


draw(ha_empty + ha_class + ha_lipid + ha_formula + h_atmperc2 + ha1 + ha2 + ha3 + ha4 + ha5, annotation_legend_list = list(lgd_lipid, lgd_pvalue, lgd_sig), heatmap_legend_side = "right", annotation_legend_side = "right", merge_legends = TRUE)


for(i in 1:3) {
    decorate_annotation("foo", slice = i, {
        grid.text(paste(text_list[[i]], collapse = "\n"), x = unit(2, "mm"), rot = 90, just = "center")
    })
}
```


### All classifications, site specific stats 
```{r}
#atom percent
#matrix
mat_atmperc_sep <- as.matrix(just_classified_sep$atomperc_timepoint_avg_1year)

h_atmperc_sep <- Heatmap(mat_atmperc_sep, name = "EAF", row_split = just_classified_sep$classification, col = col_atm_fun, row_title = NULL, column_title = expression(""^13*"C EAF"[year]), cluster_rows = FALSE, cluster_row_slices = FALSE, column_title_side = "bottom", width = unit(2, "cm"))

#p value enrichment
p_enrich_sep = as.vector(just_classified_sep$p_enrich)
# label significant with asterisk
is_sig_sep = p_enrich_sep < 0.01
pch_sep = rep("*", length(is_sig_sep))
pch_sep[!is_sig_sep] = NA
# color mapping for -log10(pvalue)
pvalue_col_fun = circlize::colorRamp2(c(0, 2, 3), c("#33A02C", "white", "#6A3D9A")) 
ha2_sep = rowAnnotation(p = anno_simple(-log10(p_enrich_sep), 
        col = pvalue_col_fun, pch = pch_sep), annotation_name_rot = 0)
# generate two legends
# legend for pvalue
lgd_pvalue = Legend(title = "p-value", col_fun = pvalue_col_fun, at = c(0, 1, 2, 3), 
    labels = c("1", "0.1", "0.01", "0.001"))
# and one for the significant p-values
lgd_sig = Legend(pch = "*", type = "points", labels = "< 0.01")


#D value enrichment
effsize_enrich_sep = as.vector(just_classified_sep$effsize_enrich)
effsize_enrich_sep <- round(effsize_enrich_sep, digits = 1)
ha1_sep = rowAnnotation("d" = anno_numeric(effsize_enrich_sep, 
        bg_gp = gpar(fill = ifelse(effsize_enrich_sep > 0, "#33A02C", "#6A3D9A"), col = ifelse(effsize_enrich_sep > 0, "#33A02C", "#6A3D9A")), width = unit(3, "cm")), annotation_name_rot = 0)

#intensity barplot
ratio_sep = as.vector(just_classified_sep$log2FC_intensity)
ha3_sep = rowAnnotation("Log2FC intensity" = anno_barplot(ratio_sep, baseline = 0, gp = gpar(fill = "#1F78B4", col = "#1F78B4"), width = unit(3, "cm")))

#p value intensity
#p value enrichment
p_intensity_sep = as.vector(just_classified_sep$p_intensity)
# label significant with asterisk
is_sig2_sep = p_intensity_sep < 0.01
pch2_sep = rep("*", length(is_sig2_sep))
pch2_sep[!is_sig2_sep] = NA

ha5_sep = rowAnnotation(p = anno_simple(-log10(p_intensity_sep), 
        col = pvalue_col_fun, pch = pch2_sep), annotation_name_rot = 0)

#D value intensity 
effsize_intensity_sep = as.vector(just_classified_sep$effsize_intensity)
effsize_intensity_sep <- round(effsize_intensity_sep, digits = 1)
ha4_sep = rowAnnotation("d" = anno_numeric(effsize_intensity_sep, 
        bg_gp = gpar(fill = ifelse(effsize_intensity_sep > 0, "#33A02C", "#6A3D9A"), col = ifelse(effsize_intensity_sep > 0, "#33A02C", "#6A3D9A")), width = unit(3, "cm")), annotation_name_rot = 0)

#Site annotation 
ha_site_sep = rowAnnotation(
  #site annotation
    Site = just_classified_sep$site_desig, 
    col = list(Site = c("Wisconsin" = "#E31A1C", "Michigan" = "#1F78B4")), show_legend = FALSE)
lgd_site_sep = Legend(title = "Site", legend_gp = gpar(fill = c("#E31A1C", "#1F78B4")),
    labels = c("Wisconsin", "Michigan"))

#Lipid type annotations 
#vector for colors 
class_colors_sep <- just_classified_sep %>% mutate(class_colors = case_when(
  `Main class` == "DG" ~ "#FDBF6F",
  `Main class` == "FA" ~ "#CAB2D6", 
  `Main class` == "PC" ~ "#A6CEE3", 
  `Main class` == "PE" ~ "#1F78B4", 
  `Main class` == "PG" ~ "#B2DF8A", 
  `Main class` == "PI" ~ "#33A02C", 
  `Main class` == "TG" ~ "#FF7F00", 
  `Main class` == "Cer" ~"#FB9A99", 
  `Main class` == "DGTSA" ~ "#E31A1C",
),
class_colors = as.character(class_colors)) %>% ungroup() %>% select(c(class_colors, `Main class`)) 
class_colors_sep_vec = class_colors_sep$class_colors

class_colors_sep_uniq = class_colors_sep %>% distinct() %>% mutate(`Main class` = factor(`Main class`, levels = c("PC", "PE", "PG", "PI", "Cer", "DGTSA", "DG", "TG", "FA"))) %>% arrange(`Main class`)

ha_lipid_sep = rowAnnotation(
  #class annotation 
    Class = anno_text(just_classified_sep$`Compound`, location = 0.5, just = "center", gp = gpar(fill = class_colors_sep_vec, col = "white")))
lgd_lipid_sep = Legend(title = "Lipid class", legend_gp = gpar(fill = class_colors_sep_uniq$class_colors),
    labels = class_colors_sep_uniq$`Main class`)

 #list(bar = c("a" = "red", "b" = "green", "c" = "blue"))
  
#Lipid formula annotations 
ha_formula_sep = rowAnnotation(
   #DBE
    `chain DBE` = just_classified_sep$`Mean DBE per chain`,
  #total C annotation 
    `chain C` = just_classified_sep$`Mean # of C per chain`,
    col = list(`chain DBE` = col_DBE_fun, `chain C` = col_C_fun)
)

#group by classification 
ha_class_sep <- rowAnnotation(Classification = classification_sep, show_annotation_name = FALSE, show_legend = FALSE,
    col = list(Classification = c("persistent" = "#CAB2D6", "continued production" = "#B2DF8A", "degraded" = "#A6CEE3")))
#label classifications
text_list = list(
    text1 = "persistent",
    text2 = "continued production",
    text3 = "degraded"
)
ha_empty_sep = rowAnnotation(foo = anno_empty(border = FALSE, 
    width = unit(5, "mm")))
        #,annotation_legend_param = list(
            #classification = list(direction = "horizontal", title_position = "lefttop", nrow = 1)))


draw(ha_empty_sep + ha_class_sep + ha_site_sep + ha_lipid_sep + ha_formula_sep + h_atmperc_sep + ha1_sep + ha2_sep + ha3_sep + ha4_sep + ha5_sep, annotation_legend_list = list(lgd_site_sep, lgd_lipid_sep, lgd_pvalue, lgd_sig), heatmap_legend_side = "right", annotation_legend_side = "right", merge_legends = TRUE)


for(i in 1:3) {
    decorate_annotation("foo", slice = i, {
        grid.text(paste(text_list[[i]], collapse = "\n"), x = unit(2, "mm"), rot = 90, just = "center")
    })
}
```


